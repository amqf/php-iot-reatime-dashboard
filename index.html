<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stacked Line Component with WebSocket</title>
  <!-- Importing React and ReactDOM via CDN -->
  <script src="https://unpkg.com/react/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom/umd/react-dom.development.js" crossorigin></script>
  <!-- Importing Material-UI core components via CDN -->
  <script src="https://unpkg.com/@mui/material/umd/material-ui.development.js" crossorigin></script>
  <!-- Importing ECharts via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.1/dist/echarts.min.js"></script>
  <!-- Importing Babel via CDN -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    .chart-container {
      width: 100%;
      height: 400px;
      margin-bottom: 20px;
    }

    .gauge-container {
      position: relative;
      width: 100%;
      height: 400px;
    }
  </style>
</head>

<body>
  
  <div id="root"></div>
  <script type="text/babel">
    const { useEffect, useRef, useState } = React;
    const { Box } = MaterialUI;

    // Function to initialize and manage the WebSocket connection
    const useWebSocket = (url, onMessage) => {
      useEffect(() => {
        const socket = new WebSocket(url);

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          onMessage(data);
        };

        socket.onerror = (error) => {
          console.error('WebSocket Error: ', error);
        };

        socket.onopen = () => {
          console.log('WebSocket connection established.');
        };

        socket.onclose = () => {
          console.log('WebSocket connection closed.');
        };

        return () => {
          socket.close();
        };
      }, [url, onMessage]);
    };

    // React component for Gauge
    const GaugeComponent = ({ targetKey }) => {
      const chartRef = useRef(null);

      // Hook to setup WebSocket and handle messages
      useWebSocket('ws://localhost:8081', (data) => {
        if (data.key === targetKey) {
          const value = parseFloat(data.value).toFixed(2);
          updateGauge(value);
        }
      });

      // Function to update gauge chart
      const updateGauge = (value) => {
        if (chartRef.current) {
          const chart = echarts.init(chartRef.current);
          const option = {
            series: [
              {
                type: 'gauge',
                axisLine: {
                  lineStyle: {
                    width: 30,
                    color: [
                      [0.3, '#67e0e3'],
                      [0.7, '#37a2da'],
                      [1, '#fd666d']
                    ]
                  }
                },
                pointer: {
                  itemStyle: {
                    color: 'auto'
                  }
                },
                axisTick: {
                  distance: -30,
                  length: 8,
                  lineStyle: {
                    color: '#fff',
                    width: 2
                  }
                },
                splitLine: {
                  distance: -30,
                  length: 30,
                  lineStyle: {
                    color: '#fff',
                    width: 4
                  }
                },
                axisLabel: {
                  color: 'inherit',
                  distance: 40,
                  fontSize: 20
                },
                detail: {
                  valueAnimation: true,
                  formatter: '{value} psi',
                  color: 'inherit'
                },
                data: [
                  {
                    value
                  }
                ]
              }
            ]
          };
          chart.setOption(option);
        }
      };

      // Render the gauge component
      return <Box className="gauge-container" ref={chartRef}></Box>;
    };

    // React component for Stacked Line Chart
    const StackedLineComponent = ({ lines }) => {
      const chartRef = useRef(null);
      const chartInstanceRef = useRef(null);
      const [data, setData] = useState({});

      // Initialize data state with empty arrays for each line
      useEffect(() => {
        const initialData = {};
        lines.forEach(line => {
          initialData[line.data] = [];
        });
        setData(initialData);
      }, [lines]);

      // Hook to setup WebSocket and handle messages
      useWebSocket('ws://localhost:8081', (receivedData) => {
        const newData = { ...data };
        const { key, value } = receivedData;
        if (newData[key]) {
          if (newData[key].length >= 7) {
            newData[key].shift();
          }
          newData[key].push(parseFloat(value));
          setData(newData);
        }
      });

      // Function to initialize or update the chart
      useEffect(() => {
        if (chartRef.current) {
          const chart = chartInstanceRef.current || echarts.init(chartRef.current);
          chartInstanceRef.current = chart;

          const option = {
            xAxis: {
              type: 'category',
              data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
            },
            yAxis: {
              type: 'value'
            },
            series: lines.map(line => ({
              ...line,
              data: data[line.data] || []
            }))
          };

          chart.setOption(option);
        }
      }, [data, lines]);

      return <Box className="chart-container" ref={chartRef}></Box>;
    };

    // Main App component rendering the StackedLineComponent
    const App = () => {
      const lines = [
        {
          name: 'Indicator 1',
          type: 'line',
          stack: 'Total',
          data: 'organization/system/indicator_1'
        },
        {
          name: 'Indicator 2',
          type: 'line',
          stack: 'Total',
          data: 'organization/system/indicator_2'
        },
      ];

      return (
        <div>
          <StackedLineComponent lines={lines} />
          <GaugeComponent targetKey="organization/system/indicator_1" />
          <GaugeComponent targetKey="organization/system/indicator_2" />
        </div>
      );
    };

    // Rendering the App component
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>

</html>